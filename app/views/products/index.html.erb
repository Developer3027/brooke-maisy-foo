<% content_for :title, @page_title %>
<% content_for :description, @meta_description %>

<!-- Breadcrumbs -->
<%= render 'shared/breadcrumbs', breadcrumbs: [
  { text: 'Shop', url: products_path },
  (@current_category ? { text: @current_category.name, url: category_path(@current_category) } : nil),
  (@search_query.present? ? { text: "Search: #{@search_query}", url: nil } : nil)
].compact %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Page Header -->
  <div class="mb-8">
    <% if @current_category %>
      <h1 class="text-3xl font-bold text-ivory-900 mb-2"><%= @current_category.name %></h1>
      <% if @current_category.description.present? %>
        <p class="text-ivory-600 text-lg"><%= @current_category.description %></p>
      <% end %>
    <% elsif @search_query.present? %>
      <h1 class="text-3xl font-bold text-ivory-900 mb-2">Search Results</h1>
      <p class="text-ivory-600 text-lg">
        Showing results for "<%= @search_query %>" 
        <span class="text-sm">(<%= pluralize(@total_count, 'product') %> found)</span>
      </p>
    <% else %>
      <h1 class="text-3xl font-bold text-ivory-900 mb-2">All Products</h1>
      <p class="text-ivory-600 text-lg">Discover our complete collection of handmade crafts</p>
    <% end %>
  </div>

  <div class="lg:grid lg:grid-cols-4 lg:gap-8">
    <!-- Sidebar Filters -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-lg shadow-sm p-6 mb-6 lg:mb-0 sticky top-20">
        <h3 class="text-lg font-semibold text-ivory-900 mb-4">Filters</h3>
        
        <%= form_with url: products_path, method: :get, local: true, class: "space-y-6" do |form| %>
          <!-- Preserve search query -->
          <%= form.hidden_field :search, value: @search_query if @search_query.present? %>
          
          <!-- Categories -->
          <div>
            <h4 class="text-sm font-medium text-ivory-900 mb-3">Categories</h4>
            <div class="space-y-2">
              <%= link_to products_path(search: @search_query), 
                  class: "block text-sm #{'font-medium text-ivory-900' if @current_category.nil?} #{'text-ivory-600 hover:text-ivory-800' unless @current_category.nil?} transition-colors" do %>
                All Categories
              <% end %>
              <% @categories.each do |category| %>
                <%= link_to products_path(category_id: category.id, search: @search_query), 
                    class: "block text-sm #{'font-medium text-ivory-900' if @current_category == category} #{'text-ivory-600 hover:text-ivory-800' unless @current_category == category} transition-colors" do %>
                  <%= category.name %>
                  <span class="text-xs text-ivory-400 ml-1">(<%= category.products.active.count %>)</span>
                <% end %>
              <% end %>
            </div>
          </div>

          <!-- Price Range -->
          <div>
            <h4 class="text-sm font-medium text-ivory-900 mb-3">Price Range</h4>
            <div class="space-y-2">
              <% [
                ['All Prices', ''],
                ['Under $10', 'under_10'],
                ['$10 - $25', '10_25'],
                ['$25 - $50', '25_50'],
                ['Over $50', 'over_50']
              ].each do |label, value| %>
                <label class="flex items-center">
                  <%= form.radio_button :price_range, value, 
                      checked: @price_range == value,
                      class: "text-ivory-600 focus:ring-ivory-500 border-ivory-300" %>
                  <span class="ml-2 text-sm text-ivory-700"><%= label %></span>
                </label>
              <% end %>
            </div>
          </div>

          <!-- Availability -->
          <div>
            <h4 class="text-sm font-medium text-ivory-900 mb-3">Availability</h4>
            <div class="space-y-2">
              <% [
                ['All Products', ''],
                ['In Stock', 'in_stock'],
                ['Out of Stock', 'out_of_stock']
              ].each do |label, value| %>
                <label class="flex items-center">
                  <%= form.radio_button :availability, value, 
                      checked: @availability == value,
                      class: "text-ivory-600 focus:ring-ivory-500 border-ivory-300" %>
                  <span class="ml-2 text-sm text-ivory-700"><%= label %></span>
                </label>
              <% end %>
            </div>
          </div>

          <!-- Apply Filters Button -->
          <div class="pt-4 border-t border-ivory-200">
            <%= form.submit "Apply Filters", 
                class: "w-full bg-ivory-500 hover:bg-ivory-600 text-white py-2 px-4 rounded-md font-medium transition-colors" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Main Content -->
    <div class="lg:col-span-3">
      <!-- Sort and View Options -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
        <div class="flex items-center text-sm text-ivory-600">
          Showing <%= (@page - 1) * @per_page + 1 %>-<%= [@page * @per_page, @total_count].min %> of <%= @total_count %> products
        </div>
        
        <div class="flex items-center gap-4">
          <!-- Sort Options -->
          <%= form_with url: request.path, method: :get, local: true, class: "flex items-center gap-2" do |form| %>
            <!-- Preserve all current params -->
            <% params.except(:sort, :page).each do |key, value| %>
              <%= form.hidden_field key, value: value %>
            <% end %>
            
            <label for="sort" class="text-sm text-ivory-700 font-medium">Sort by:</label>
            <%= form.select :sort, [
              ['Newest', 'newest'],
              ['Oldest', 'oldest'],
              ['Name A-Z', 'name_asc'],
              ['Name Z-A', 'name_desc'],
              ['Price Low-High', 'price_asc'],
              ['Price High-Low', 'price_desc'],
              ['Featured', 'featured']
            ], { selected: @sort_option }, {
              class: "text-sm border-ivory-300 rounded-md focus:ring-ivory-500 focus:border-ivory-500",
              onchange: "this.form.submit();"
            } %>
          <% end %>
        </div>
      </div>

      <!-- Products Grid -->
      <% if @products.any? %>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          <% @products.each do |product| %>
            <%= render 'shared/product_card', product: product %>
          <% end %>
        </div>

        <!-- Pagination -->
        <% if @total_pages > 1 %>
          <nav class="flex items-center justify-between border-t border-ivory-200 pt-6">
            <div class="flex-1 flex justify-between sm:hidden">
              <!-- Mobile pagination -->
              <% if @page > 1 %>
                <%= link_to "Previous", 
                    request.path + "?" + request.query_parameters.merge(page: @page - 1).to_query,
                    class: "relative inline-flex items-center px-4 py-2 border border-ivory-300 text-sm font-medium rounded-md text-ivory-700 bg-white hover:bg-ivory-50" %>
              <% end %>
              <% if @page < @total_pages %>
                <%= link_to "Next", 
                    request.path + "?" + request.query_parameters.merge(page: @page + 1).to_query,
                    class: "ml-3 relative inline-flex items-center px-4 py-2 border border-ivory-300 text-sm font-medium rounded-md text-ivory-700 bg-white hover:bg-ivory-50" %>
              <% end %>
            </div>
            
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
              <div>
                <p class="text-sm text-ivory-700">
                  Showing page <span class="font-medium"><%= @page %></span> of <span class="font-medium"><%= @total_pages %></span>
                </p>
              </div>
              <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                  <!-- Previous -->
                  <% if @page > 1 %>
                    <%= link_to request.path + "?" + request.query_parameters.merge(page: @page - 1).to_query,
                        class: "relative inline-flex items-center px-2 py-2 rounded-l-md border border-ivory-300 bg-white text-sm font-medium text-ivory-500 hover:bg-ivory-50" do %>
                      <span class="sr-only">Previous</span>
                      <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                      </svg>
                    <% end %>
                  <% end %>
                  
                  <!-- Page Numbers -->
                  <% page_range = [[@page - 2, 1].max, [@page + 2, @total_pages].min] %>
                  <% (page_range[0]..page_range[1]).each do |page_num| %>
                    <% if page_num == @page %>
                      <span class="relative inline-flex items-center px-4 py-2 border border-ivory-500 bg-ivory-50 text-sm font-medium text-ivory-600">
                        <%= page_num %>
                      </span>
                    <% else %>
                      <%= link_to page_num,
                          request.path + "?" + request.query_parameters.merge(page: page_num).to_query,
                          class: "relative inline-flex items-center px-4 py-2 border border-ivory-300 bg-white text-sm font-medium text-ivory-700 hover:bg-ivory-50" %>
                    <% end %>
                  <% end %>
                  
                  <!-- Next -->
                  <% if @page < @total_pages %>
                    <%= link_to request.path + "?" + request.query_parameters.merge(page: @page + 1).to_query,
                        class: "relative inline-flex items-center px-2 py-2 rounded-r-md border border-ivory-300 bg-white text-sm font-medium text-ivory-500 hover:bg-ivory-50" do %>
                      <span class="sr-only">Next</span>
                      <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                      </svg>
                    <% end %>
                  <% end %>
                </nav>
              </div>
            </div>
          </nav>
        <% end %>
      <% else %>
        <!-- No Products Found -->
        <div class="text-center py-12">
          <div class="text-6xl mb-4">🔍</div>
          <h3 class="text-xl font-semibold text-ivory-900 mb-2">No products found</h3>
          <p class="text-ivory-600 mb-6">
            <% if @search_query.present? %>
              We couldn't find any products matching "<%= @search_query %>".
            <% elsif @current_category %>
              No products are currently available in this category.
            <% else %>
              No products match your current filters.
            <% end %>
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <% if @search_query.present? || params.except(:controller, :action).any? %>
              <%= link_to "Clear Filters", products_path, 
                  class: "bg-ivory-500 hover:bg-ivory-600 text-white px-6 py-2 rounded-md font-medium transition-colors" %>
            <% end %>
            <%= link_to "Browse All Products", products_path, 
                class: "border border-ivory-500 text-ivory-700 hover:bg-ivory-500 hover:text-white px-6 py-2 rounded-md font-medium transition-colors" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>